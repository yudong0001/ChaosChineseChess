
<script type="text/javascript" src="/javascripts/jquery.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){
    
    var EMPTY_NAME = 'ç©º';

    var rowsCount = <%=rowsCount%>;
    var columnsCount = <%=columnsCount%>;
    var cellSize = <%=cellSize%>;

    function getCellFromMami(jqMami) {
        var x = jqMami.css('left');
        var y = jqMami.css('top');
        x = x.substring(0, x.length - 2) / cellSize;
        y = y.substring(0, y.length - 2) / cellSize;
        return {x: x, y: y};
    }

    function updateMamiForCell(jqMami, cell) {
        console.log('cell in update function: %o',cell);//*********
        if (cell.hidden) {
            return;
        } else {
            jqMami.addClass('discovered');
        }
        if (cell.name == EMPTY_NAME) {
            jqMami.removeClass('red discovered selected').addClass('discovered empty').text('');
        } else {
            jqMami.removeClass('red black').addClass(cell.camp).text(cell.name);
        }
    }

    var ai = false;

    function updateCell(cell) {
        console.log('cell in update function: %o',cell);//*********
        var jqMami = $('#cell'+cell.y+cell.x);
        if (cell.hidden) {
            return;
        } else {
            jqMami.addClass('discovered');
        }
        if (cell.name == EMPTY_NAME) {
            jqMami.removeClass('red black selected').addClass('empty').text('');
        } else {
            jqMami.removeClass('red black selected').addClass(cell.camp).text(cell.name);
        }
    }

    function updateBoard(){
        console.log('Update board.');//*********
        $('.cell').each(function(i, o){
            var jqMami = $(o);
            updateMamiForCell(jqMami, getCellFromMami(jqMami));
        });
    }

    function trigAI(){
        console.log('trigger AI action.ai:'+ai);//***********
        /*var isai = isAI;
        if(isai){
            isai = false;
            $('#cell00').trigger('click');
        }
        return isai;*/
        var maxCellC = columnsCount-1;
        var maxCellR = rowsCount-1;
        $('#cell' + maxCellR + maxCellC ).trigger('click');
        console.log('cell triggered for AI: #cell' + maxCellR + maxCellC );//**************
    };

    /*$.post('/play', {x:1, y:1}, function(data){
        console.log('result for post to /play: %o',data);
    });*/

    //var playerId = "humanPlayer";
    $('.cell').click(function(e){
        console.log('cell click called: %o',e);//***************

        var clicked = $(e.currentTarget);
        var cellPos = getCellFromMami(clicked);
        var wTime = 50;
        console.log('ai in loc1:'+ai);//************

        $.post('/play',{ player:ai?"AI":"humanPlayer" ,x:cellPos.x, y:cellPos.y }, function(data){
            console.log('resp data from server: %o',data);
            switch (data.action){
                case 'discover':
                    //$('#cell'+data.cell.y+data.cell.x).addClass('discovered ' + data.cell.camp).text(data.cell.name);
                    updateCell(data.cell);
                    ai = !ai;break;
                case 'select':$('#cell'+data.cell.y+data.cell.x).addClass('selected');break;
                case 'unselect':$('#cell'+data.cell.y+data.cell.x).removeClass('selected');break;
                case 'xselect':$('.cell').removeClass('selected');$('#cell'+data.cell.y+data.cell.x).addClass('selected');break;
                case 'kill':
                    /*$('#cell'+data.killed.y+data.killed.x).removeClass(data.killed.camp).addClass(data.killer.camp).text(data.killer.name);
                    $('#cell'+data.killer.y+data.killer.x).removeClass('selected '+data.killer.camp).text(" ");*/
                    $('#cell'+data.killer.y+data.killer.x).addClass('selected');
                    wTime = 1000;
                    setTimeout(function(){
                        updateCell(data.killer);
                        updateCell(data.killed);
                        ai = !ai;
                    }, wTime);
                    break;
                case 'finished':ai = false;break;
                case 'pass':ai = false;break;
            }
            //updateBoard();
            console.log('ai after post: '+ ai);//**********
            setTimeout(function(){
                wTime = 50;
                if(ai){
                    console.log('trig AI');//**********
                    trigAI();
                }
            }, wTime);
            
        });
    });

    /*function updateBoard(){
        $('.cell').each(function(i, o){
            var jqMami = $(o);
            updateMamiForCell(jqMami, getCellFromMami(jqMami));
        });
    }*/

    //setInterval("ai=trigAI(ai)",5000);

});

</script>